\documentclass[twoside,a4paper]{refart}
\usepackage[utf8x]{inputenc}
%\usepackage[czech]{babel}
\usepackage[pdftex]{graphicx}
\graphicspath{{resources/images/}{resources/appNotes/002/images/}}
\usepackage{caption}% for \captionof
\usepackage{mwe}% contains example-image
\usepackage[owncaptions]{vhistory}
\usepackage{hyperref}
%\usepackage[superscript,biblabel]{cite}
\usepackage{multirow}
\usepackage{wrapfig}
\usepackage{float}
\usepackage{fancyvrb}

\usepackage[table, x11names]{xcolor}
\usepackage{array, booktabs, boldline} %
\usepackage{mathtools}

\newsavebox{\tempbox}
\newlength{\tempheight}

\newcommand\ToDo[1]{\textcolor{red}{ToDo: #1}}

%skryt barevny obdelnik kolem odkazu
\hypersetup{
    colorlinks=false,
    pdfborder={0 0 0},
}

% vhistory
\renewcommand{\vhhistoryname}{Revision History}
\renewcommand{\vhchangename}{Note}
\renewcommand{\vhversionname}{Revision}
\renewcommand{\vhdatename}{Date}
\renewcommand{\vhauthorname}{Author}
\renewcommand \vhAuthorColWidth{0.8\hsize}
\renewcommand \vhChangeColWidth{1.2\hsize}

\DeclareRobustCommand{\UWBLogo}{%
   \begin{wrapfigure}{l}{2.1cm}
    \vspace{-1.35cm}
    \includegraphics[width=2cm]{ZCU_logo.pdf}
   \end{wrapfigure}
}

\title{\UWBLogo KETCube AppNote 002:\\ LoRa Configuration (\vhCurrentVersion)}

\author{Author: \vhListAllAuthors}

\begin{document}
\pagenumbering{roman} 

\titlepage
\maketitle

\section*{About this Document}
\input{resources/about.tex}

This document describes how to set-up the KETCube as a LoRaWAN class A device.


\setcounter{tocdepth}{1}
\tableofcontents
\clearpage

\listoffigures
\listoftables
\begin{versionhistory}
  \vhEntry{03/2018}{03.03.2018}{Jan Bělohoubek}{Initial version}
  \vhEntry{05/2018}{07.05.2018}{Jan Bělohoubek, Kryštof Vaněk, Matin Úbl}{Terminal configuration, text review, minor fixes}
\end{versionhistory}
% history table ... do not number
\setcounter{table}{0}

\clearpage 
\pagenumbering{arabic} 
\pagestyle{headings} 

\clearpage
\clearpage
\section{Introduction}
  KETCube can be used as a LoRaWAN Class A device. Many LoRaWAN parameters can be set through KETCube Terminal -- see KETCube specification \cite{ZCU:KETCube:05-2018}. Some parameters can be set by using Terminal or statically (KETCube Terminal configuration will be ignored when static configuration is used) or only statically (it is not possible to configure all parameters through KETCube Terminal).

  This document does not cover the LoRaWAN standard or terminology. Please refer the Lora Alliance websites\footnote{https://lora-alliance.org/}, LoRaWAN specification\footnote{https://lora-alliance.org/lorawan-for-developers} or see one of the knowledge bases on the web: the TTN documentation is a good starting point \footnote{https://www.thethingsnetwork.org/docs/lorawan/}.
  
\clearpage

\section{LoRaWAN Stack Terminal Configuration}
Most of the LoRaWAN parameters can be set by using the KETCube Terminal interface. The KETCube Terminal basics are described in KETCube Datasheet \cite{ZCU:KETCube:05-2018}.

Write command {\tt show LoRa} or {\tt set LoRa} to display commands related to LoRa:

\begin{Verbatim}[frame=single, fontsize=\small]
> show LoRa
ABP          Is ABP enabled?
OTAA         Is OTAA enabled?
appEUI       Show LoRa application EUI.
appKey       Show LoRa application key.
appSKey      Show LoRa app session Key
devAddr      Show LoRa device address.
devEUI       Show LoRa device EUI.
devEUIType   Show LoRa device EUI type: custom (user-defined) 
             or deviceID-based.
nwkSKey      Show LoRa network session Key.

> set LoRa
ABP          Enable ABP.
OTAA         Enable OTAA.
appEUI       Set LoRa application EUI.
appKey       Set LoRa application key.
appSKey      Set LoRa app session Key
devAddr      Set LoRa device address.
devEUI       Set LoRa device EUI.
devEUICustom Use custom (user-defined) LoRa device EUI
devEUIBoard  Use board (boardID-based) LoRa device EUI
nwkSKey      Set LoRa network session Key.
\end{Verbatim}

\subsection{LoRaWAN Node Activation}
To set OTAA/ABP mode or show which mode is enabled/disabled, use following commands: {\tt show LoRa OTAA}/{\tt show LoRa ABP} and {\tt set LoRa OTAA}/{\tt set LoRa ABP}

\subsection{LoRaWAN devEUI}
User-defined devEUI ({\tt set LoRa devEUICustom} and {\tt set LoRa devEUI}), or manufacturer's devEUI ({\tt set LoRa devEUIBoard}) can be used. The selected option can be checked via {\tt show LoRa devEUIType} and {\tt show LoRa devEUI} commands.

\subsubsection*{Example: Set user-defined devEUI}
\begin{Verbatim}[frame=single, fontsize=\small]
> set LoRa devEUI 1122334455667788
> set LoRa devEUICustom
> reload

> show LoRa devEUI

Custom devEUI is displayed ...

\end{Verbatim}

\subsubsection*{Example: Use Manufacturer's devEUI}
\begin{Verbatim}[frame=single, fontsize=\small]
> set LoRa devEUIBoard
> reload

> show LoRa devEUI

Board devEUI is displayed ...
\end{Verbatim}

\subsection{LoRaWAN OTAA Parameters}
The LoRaWAN appEUI and appKey can be set by using {\tt set LoRa appEUI} and {\tt set LoRa appKey} commands and checked by using {\tt show LoRa appEUI} and {\tt show LoRa appKey} commands.
  
\subsubsection*{Example: Set OTAA parameters}
\begin{Verbatim}[frame=single, fontsize=\small]
> set LoRa appEUI 1122334455667788
> set LoRa appKey 11223344556677881122334455667788
\end{Verbatim}
  
\subsection{LoRaWAN ABP Parameters}
The LoRaWAN appSKey and nwkSKey can be set by using {\tt set LoRa appSKey} and {\tt set LoRa nwkSKey} commands and checked by using {\tt show LoRa appSKey} and {\tt show LoRa nwkSKey} commands. The static device address i configured via  {\tt set LoRa devAddr} command and checked via  {\tt show LoRa devAddr} command.
  
\subsubsection*{Example: Set ABP parameters}
\begin{Verbatim}[frame=single, fontsize=\small]
> set LoRa devAddr DEADBEEF
> set LoRa appSKey 1122334455667788
> set LoRa nwkSKey 11223344556677881122334455667788
\end{Verbatim}

\subsection{LoRaWAN Period}
The period of data transmission is given by KETCube {\it base period}. Use {\tt set core basePeriod} command to set period of data transmission for LoRa Class A device.
  
\clearpage
\section{LoRaWAN Stack Static Configuration}

\subsection{File Comissioning.h}
The {\it Comissioning.h} file is the original Semtech's LoRaWAN configuration file. 

\subsubsection{OVER\_THE\_AIR\_ACTIVATION}
The OTAA or ABP selection is configured here by setting this macro to 1 for OTAA or to 0 for ABP.

\subsubsection{LORAWAN\_DEVICE\_EUI} 
Defines a static devEUI if {\bf STATIC\_DEVICE\_EUI} macro is set to 1.

\subsubsection{LORAWAN\_APPLICATION\_EUI}
AppEUI for the OTAA mode.

\subsubsection{LORAWAN\_APPLICATION\_KEY} 
AppKey for the OTAA mode.

\subsubsection{LORAWAN\_DEVICE\_ADDRESS} 
Defines a static device address when {\bf STATIC\_DEVICE\_ADDRESS} is set to 1.

\subsubsection{LORAWAN\_NWKSKEY}
Defines the LoRa NWK Key used when ABP mode is used.

\subsubsection{LORAWAN\_APPSKEY} 
Defines the LoRa APP Key used when ABP mode is used.

\subsection{File ketCube\_lora.c}
The {\it ketCube\_lora.c} file currently contains defines for advanced LoRaWAN configuration.

\subsubsection{LORAWAN\_ADR\_ON}
This define allows to enable/disable LoRaWAN adaptive data rate.

\subsubsection{LORAWAN\_CONFIRMED\_MSG}
This define allows to enable/disable LoRaWAN confirmed messages.

\subsubsection{LORAWAN\_APP\_PORT}
This define allows to set-up the KETCube LoRaWAN uplink message port.

\clearpage
\section{Application Testing}
\subsection{LoRaWAN Uplink Test}
In LoRaWAN, the term {\it uplink} denotes the direction of the data transmission from the LoRaWAN node to the LoRaWAN network server.

To test uplink, configure KETCube LoRaWAN parameters as described in sections above and use the same settings to configure the LoRaWAN node on your LoRaWAN network server.

Then enable some of the KETCube sensing modules and KETCube LoRa module and by using the KETCube Terminal interface. Don't forget to reload KETCube to apply configuration:

\begin{Verbatim}[frame=single, fontsize=\small]
> enable BatMeas
> enable HDC1080
> enable LoRa
> reload
\end{Verbatim}

After reload, you should observe incoming packets at your LoRaWAN server.

\subsection{LoRaWAN Downlink Test}
In LoRaWAN, the term {\it downlink} denotes the direction of the data transmission from the LoRaWAN network server to the LoRaWAN node.

For downlink tests, LoRa ports 10 and 11 are dedicated in KETCube. When KETCube {\it RxDisplay} module is enabled, data received on port 10 are displayed in KETCube Terminal as HEX string and data received on port 11 as string.

To perform basic functional test, configure KETCube as follows:
\begin{Verbatim}[frame=single, fontsize=\small]
> enable RxDisplay
> enable LoRa
> reload
\end{Verbatim}

After that, send data to KETCube LoRaWAN node to port 10 or 11 and watch KETCube Terminal.

If you use the open {\it LoRa Server} ({https://www.loraserver.io/}), you can use the KETCube tool {\it ketCube\_LoRaDownlink.py} located in the {\it KETCube-tools} repository. The script automates the process of sending debug downlink packets to KETCube's port 11.

% ============================

\clearpage
\bibliographystyle{IEEEtran}
\bibliography{IEEEabrv,resources/sources}

% ============================

\input{resources/license.tex}
